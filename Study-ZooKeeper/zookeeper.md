# 本项目为基本的 zk demo

## 基本情况
* JDK：1.8.0_181
* zk：3.1.12
* one包为单机demo
* 

## zk基本概念

zookeeper（以下简称zk）是一个分布式协调服务，是用来协调各个系统的，是用java实现的，因此需要java环境。

zk=文件系统+监听通知机制，本质zk是用来存储一部分数据，但由于具有监听通知机制的特性，并不是单单用来存储数据的，一般会用来对数据变更的监听。



* 文件系统：zk是一个基于文件系统的，因此是可以用来存储一些数据，并可以持久化到硬盘上面
* 监听通知机制：当有客户端监听某个路径下的数据，当路径下的数据有进行变化（创建、更新、删除）时候，会主动对设置了监听此路径的客户端进行通知

### zk黑话&术语

1. 集群角色：zk是支持集群部署（主要是Master/Slave模式，也称主备模式）的，因此有以下几种角色：

   1. Leader：集群领导者（Master）集群中只有1个Leader，此模式下，将所有能够处理写操作的节点成为Leader节点，并将写操作同步给Follwer节点，也就是说，只有Leader节点处理写操作（写数据流程请参考下面）
   2. Follwer：集群跟随者（Slave）集群中可以有多个Follwer，对外提供读取服务的节点。
   3. Observer：Observer（等于不参与选举与过半写数据成功策略的Follwer节点）只提供读取服务。当集群对外提供的Client过多，需要维护大量的读取服务，因此需要扩展Follwer节点进行读服务操作，但是如果直接宽展Follwer节点，则必定会造成集群过大，选举时间增长，数据复制时间增长，如果Follwer挂掉过半，则整个集群不可用（可用性降低），因此引入Observer，只提供一个读服务，这种扩展对集群的性能损失较小（不过如果不保证数据的过半写，怎么保证Observer节点数据的一致性？）

2. 会话：客户端与服务端进行连接。会维护一个TCP长连接，通过这个连接，客户端主要通过心跳检测与服务器保持有效会话，也可以发送请求并接受响应，同时接受服务端的Watch事件通知

3. 数据节点：

   1. 构成集群的机器（各个节点）
   2. 构成内存数据中的最小单元（数据结构）：被称为`ZNode`，zk将所有数据存储与内存中，数据结构是一颗树。对于每个ZNode，zk都会维护一个叫做`Stat`的数据结构，该结构记录了ZNode的三个数据版本：
      1. version：当前ZNode的版本
      2. cversion：当ZNode子节点的版本
      3. aversion：当前ZNode的ACL版本

   

4. Watcher：zk允许客户端再指定节点注册一些Watcher，并且当特定的时间触发的时候，zk会通知注册监听的客户端（且注册监听是一次有效性）

5. ACL：zk采用ACL（Access Control List）策略来进行权限控制，主要有以下几种（JAVA API中的ACL不是这些）：

   1. CREATE：创建节点的权限
   2. READ：获取节点数据和子节点列表的权限
   3. WRITE：更新节点数据的权限
   4. DELETE：删除子节点的权限
   5. ADMIN：设置节点ACL的权限



### zk的运行状态：

1. LOOKING：leader选举状态
2. FOLLOWING：Follower与Leader服务器保持同步状态
3. LEADING：Leader服务器领导状态

### zk端口：

1. 对外服务端口：2181可配置
2. zk各节点间通信节点：2888，用于节点数据同步
3. zk选举使用的节点：3888，用于节点选举通信

zk的端口除了对外是在配置文件的`port=2181`，其他端口则是配置成集群时，需要进行在配置文件中写出，单机情况不需要写2跟3配置

### zk中协议

zk使用`ZAB`协议（Zookeeper Atomic Broadcast ：zk原子消息广播协议）

https://www.cnblogs.com/leesf456/p/6012777.html



## zk部署方式

* 单机
* 集群
* 伪集群

### zk特性与应用

应用是基于特性的

### zk特性

1. 顺序一致性：从一个客户端发起的事务请求，最终会严格地按照其发起顺序被应用到zk中去
2. 原子性：所有事务请求结果在整个集群中所有机器上的情况是一致的，要么都成功，要都不成功（不是半数成功就可以了吗？）
3. 单一视图：无论客户端连接到集群的那个zk，数据都是一致的
4. 可靠性：一旦服务端成功应用了一个事务，并完成对客户端的响应，那么该事务所引起的服务端状态变更将会一直保留，除非有另外一个事务对其进行了变更
5. 实时性：zk保证在一段时间内，客户端一定可以读取到最新的数据状态

## zk应用

* 注册中心
  * 将服务上下线最常用的一种使用方式，Dubbo
* 配置中心
* 数据发布/订阅
* 负载均衡
* 命名服务
* 分布式协调/通知
* 集群管理
* Master选举
* 分布式锁
* 分布式队列

## zk数据结构

## zk API使用与demo



## zk面试

### 监听器原理

待补充

### 选举机制

待补充

### CAP



